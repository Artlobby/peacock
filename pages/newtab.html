<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8">
    <title>New Tab</title>
    <link rel="stylesheet" href="https://storage.googleapis.com/non-spec-apps/mio-icons/latest/round.css">
    <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    <style>

      html {
        --background-soft: rgba(255,255,255,0.05);
        --background-firm: rgba(255,255,255,0.1);
        --background-hard: rgba(255,255,255,0.15);

        --peacock-color: #FFD563;
      }

      @font-face {
        font-family: 'Product Sans';
        font-style: normal;
        font-weight: 400;
        src: url(https://fonts.gstatic.com/s/productsans/v5/HYvgU2fE2nRJvZ5JFAumwegdm0LZdjqr5-oayXSOefg.woff2) format('woff2');
      }

      * { font-family: "Product Sans" !important; box-sizing: border-box; z-index: 2; }

      body {
        position: relative;
        background: #292A2D; margin: 0px;
        z-index: 0 !important; overflow: hidden;
      }

      .gradient::after {
        content: "";
        display: inline-block;
        position: absolute;
        top: 0px;
        right: 0px;
        left: 0px;
        bottom: 0px;
        z-index: 1;
        opacity: 0.75;
        background: linear-gradient( rgba(0,0,0,0.8), rgba(0,0,0,0) 35%, rgba(0,0,0,0) 80%, rgba(0,0,0,0.6) 100% );
      }

      header {
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
        width: 100%;
        height: -webkit-fill-available;
      }

      footer {
        display: none;

        position: absolute;
        bottom: 60px;
        right: 70px;
      }

      .home-title {
        margin-top: -450px;
      }

      .home-title span{
        position: relative;
        overflow: hidden;
        display: block;
        line-height: 1.2;
      }

      .home-title span::after{
        content: '';
        position: absolute;
        top: 0; right: 0;
        width: 100%; height: 100%;
        background: #38393B;
        animation: a-ltr-after 2s cubic-bezier(.77,0,.18,1) forwards;
        transform: translateX(-101%);
      }

      .home-title span::before{
        content: '';
        position: absolute;
        top: 0; right: 0;
        width: 100%; height: 100%;
        background: #292A2D;
        animation: a-ltr-before 2s cubic-bezier(.77,0,.18,1) forwards;
        transform: translateX(0);
      }

      #peacock {
        color: #FFD563;
        font-weight: bold;
        font-size: 100px;
        animation: peacock-shrink 2.5s forwards;
      }

      .icon {
        border-radius: 10px;
        display: inline-block;
        width: 40px; height: 40px;
        background-repeat: no-repeat !important;
        background-size: contain !important;
        filter: contrast(4) invert(1);
        opacity: 0.5;
      }

      .icon-container {
        margin-left: 10px;
        padding: 5px 5px 2px 5px;
        border-radius: 5px;
        cursor: pointer;
      }

      .icon-container:hover {
        background: var(--background-soft);
      }

      #grid {
        display: flex;
        flex-direction: row;

        position: absolute;
        top: 50%;
        left: 50%;
        margin-left: -700px;
        width: 1376px;
        height: 228px;

        animation: grid-center 2.5s forwards;
      }

      .item {
        flex-grow: 1;
        background: var(--background-firm);
        margin-left: 20px;
        border-radius: 5px;
        transition: all 0.1s;

        display: flex;
        justify-content: center;
        align-items: center;

        cursor: pointer;

        position: relative;
      }

      .item:hover {
        background: var(--background-hard);
        margin-bottom: 5px;
        margin-top: -5px;
      }

      .item:hover > .remove-item {
        opacity: 0.9;
      }

      #welcome {
        position: fixed;
        top: 25%;
        left: 50%;
        transform: translate(-50%, -50%);
      }

      #time {
        color: white;
        font-weight: bold;
        font-size: 50px;

        position: absolute;
        margin: 0px;
        top: 35px;
        left: 35px;
      }

      .favicon {
        filter: contrast(1) invert(0);
        opacity: 1;
      }

      .remove-item {
        opacity: 0;
        transition: all 0.1s;

        border: none;
        background: none;
        border-radius: 5px;

        position: absolute;
        top: 5px;
        right: 5px;
        height: 35px;
        padding: 5px;
      }

      .remove-item:hover {
        cursor: pointer;
        background: var(--background-firm);
      }

      .remove-item svg {
        filter: invert(1);
        opacity: 0.9;
      }

      #recently-visited {
        position: absolute;
        transform: translateX(20px);
        top: -60px;

        opacity: 0.95;
        color: white;
        font-weight: 400;

        text-shadow: black 0px 0px 50px;
      }

      #bg {
        width: 100%;
        height: 100%;
        position: absolute;
        top: 0px; bottom: 0px;
        right: 0px; left: 0px;
        z-index: 1 !important;
        opacity: 0;
        object-fit: cover;
        transform: scale(1.2);
      }

      @keyframes a-ltr-after{
        0% {transform: translateX(-100%)}
        100% {transform: translateX(101%)}
      }

      @keyframes a-ltr-before{
        0% {transform: translateX(0)}
        100% {transform: translateX(200%)}
      }

      @keyframes peacock-shrink{
        75% { font-size: 100px; margin-top: 0px; color: #FFD563; }
        100%{ font-size: 50px; margin-top: -200px; color: var(--peacock-color); }
      }

      @keyframes grid-center{
        75% { transform: translateY(0%); }
        100%{ transform: translateY(-50%); }
      }
    </style>
  </head>
  <body onload="startTime()">
    <img id="bg"></img>
    <p id="time"></p>

    <header>
      <h1 class="home-title">
        <span id="peacock">Peacock</span>
      </h1>
    </header>

    <div id="grid">
      <h2 id="recently-visited">Speed Dial</h2>

      <div class="item">
        <i class="material-icons-new round-add icon"></i>
      </div>
      <div class="item">
        <i class="material-icons-new round-add icon"></i>
      </div>
      <div class="item">
        <i class="material-icons-new round-add icon"></i>
      </div>
      <div class="item">
        <i class="material-icons-new round-add icon"></i>
      </div>
      <div class="item">
        <i class="material-icons-new round-add icon"></i>
      </div>
    </div>

    <footer>
      <a href="peacock://bookmarks" class="icon-container">
        <i class="material-icons-new round-bookmarks icon"></i>
      </a>
      <a href="peacock://settings" class="icon-container">
        <i class="material-icons-new round-settings icon"></i>
      </a>
    </footer>
  </body>
  <script>
    function startTime() {
      var today = new Date();
      var h = today.getHours();
      var m = today.getMinutes();
      m = (m < 10) ? "0" + m : m;

      if($('#time').text() != h + ":" + m) {
        $('#time').text(h + ":" + m);
      }

      var t = setTimeout(startTime, 1000);
    }

    $('.item').each(function(index, item) {
      $(this).click(async (e) => {
        if($(this).attr('data-url')) {
          window.location = $(this).attr('data-url');
        } else {
          setItem($(this), prompt('Enter slot url:'));
        }
      });
    });

    function setItem(item, domain) {
      if(!domain || domain == '') return;
      if(item.length == 0) return;

      try { new URL(domain) }
      catch (e) {
        try {
          domain = 'https://' + domain;
          new URL(domain);
        } catch (e) {
          alert('Invalid URL.');
          return;
        }
      }

      if(!domain.startsWith('http')) domain = 'https://' + domain;

      let icon = item.children().first();
      item.attr('data-url', domain);
      icon.attr('class', 'icon favicon');

      try {
        let host = (new URL(domain)).host;
        icon.css('background', `url(https://favicons.githubusercontent.com/${host})`);
      } catch (e) {
        icon.css('background', `url(https://favicons.githubusercontent.com/${domain})`);
      }

      let element = item[0];
      let index = Array.from(element.parentNode.children).indexOf(element) - 1;
      send('newTab', 'saveItem', {id: index, domain: domain});

      item.append('<button class="remove-item"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0V0z"/><path d="M18.3 5.71c-.39-.39-1.02-.39-1.41 0L12 10.59 7.11 5.7c-.39-.39-1.02-.39-1.41 0-.39.39-.39 1.02 0 1.41L10.59 12 5.7 16.89c-.39.39-.39 1.02 0 1.41.39.39 1.02.39 1.41 0L12 13.41l4.89 4.89c.39.39 1.02.39 1.41 0 .39-.39.39-1.02 0-1.41L13.41 12l4.89-4.89c.38-.38.38-1.02 0-1.4z"/></svg></button>');
      item.children().eq(1).click(async (e) => {
        e.stopPropagation();
        clearItem(item);
        send('newTab', 'saveItem', {id: index, domain: ""});
      });
    }

    function clearItem(item) {
      if(item.attr('data-url')) item.removeAttr('data-url');
      if(item.children().first().attr('style')) item.children().first().removeAttr('style');
      item.children().first().attr('class', 'material-icons-new round-add icon');

      if(item.children().length > 1) item.children().eq(1).remove();
    }

    function clearItems() {
      $('.item').each(function(index, item) {
        clearItem($(item));
      });
    }

    function listSites(sites) {
      for (var i = 0; i < sites.length; i++) {
        if($('.item').eq(i) && sites[i]) {
          setItem($('.item').eq(i), sites[i]);
        }
      }
    }

    function setBackground(bg) {
      if(bg.startsWith('#')) {
        $('body').css('background', bg);
        $('body').removeClass('gradient');
        $('#bg').css('opacity', '0');
      } else {
        $('#bg').attr('src', bg).on('load', function() {
          $('#bg').animate({ opacity: 1, transform: 'scale(1)' }, { duration: 500 });
          $('body').addClass('gradient');

          $('html')[0].style.setProperty("--background-soft", "rgba(0,0,0,0.25)");
          $('html')[0].style.setProperty("--background-firm", "rgba(0,0,0,0.35)");
          $('html')[0].style.setProperty("--background-hard", "rgba(0,0,0,0.5)");

          $('html')[0].style.setProperty("--peacock-color", "white");
        });
      }
    }

    try { send('newTab', 'focusSearchbar'); } catch (e) {}

    let backgrounds = ['https://images.unsplash.com/photo-1574270981993-f1df213562b3?w=1950',
                       'https://images.unsplash.com/photo-1575761344173-aa186491c120?w=1950',
                       'https://images.unsplash.com/photo-1575138312433-d42e9f176f6b?w=1950',
                       'https://images.unsplash.com/photo-1573614071230-c814e95ae3d1?w=2049']

    let random_bg = backgrounds[Math.floor(Math.random() * backgrounds.length)];
    setBackground(random_bg);

    listSites(sendSync('newTab', 'loadItems'));
  </script>
</html>
